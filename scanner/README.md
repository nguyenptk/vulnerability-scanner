## Scanner 
The Scanner is service that allow the client can request a scanning via API to scan the vulnerabilities of the repositories in Github. There are two types of repositories: `public & private`.

The private repository needs the `$GITHUB_TOKEN` to access and clone the repository.

Currently, Scanner supports only one API `/scan`

## How it works
The Scanner will: 
- authenticate to Github (private repository) and clone the repository to the local machine
- scan the vulnerability by the signature which is configured in `scanner/server/scanner/signatures/signatures.go`
- count the stats of vulnerabilities before logging them into the console log, return the result to client and save it to the database (MySQL)

## What the features are
The Scanner supports:
- multi repositories at one time scanning by `repos`
- scan in the target path of the repositories by `target`

## How to use
There are two ways to call the Scanner:

- Via API-Gateway (recommened)
```
export SCANNER_PATH=http://localhost:8080/scanner/v1/scan
```
- Directly
```
export SCANNER_PATH=http://localhost:8090/scan
```

### 1. Public repository (There is a bug here -> not recommend using now)
```
curl -i -X GET "$SCANNER_PATH" \
          -H "repos: nguyenptk/hello-world"
```

### 2. Private repository
```
curl -i -X GET "$SCANNER_PATH" \
          -H "repos: nguyenptk/hello-world" \
          -H "token: $GITHUB_TOKEN"
```

### 3. Multi repositories (There is a bug here -> not recommend using now)
```
curl -i -X GET "$SCANNER_PATH" \
          -H "repos: nguyenptk/hello-world,guardrailsio/awesome-golang-security" \
          -H "token: $GITHUB_TOKEN"
```

### 4. In target path 
```
curl -i -X GET "$SCANNER_PATH" \
          -H "repos: nguyenptk/hello-world" \
          -H "token: $GITHUB_TOKEN"
          -H "target: test"
```

## What is the result
Please read the schema [here](/storage/README.md) firstly.
### 1. Find the vulnerabilities in the repository
When the Scanner finds some vulnerabilities, the client will receive the body:
```
{
  "message": {
    "id": "696b0651-368a-4195-bfb8-f9e0864bc698",
    "queue_at": "2022-06-04T07:44:32.514582629Z",
    "started_at": "2022-06-04T07:44:32.514581962Z",
    "finished_at": "2022-06-04T07:44:35.040698713Z",
    "status": "Success",
    "progress": 100,
    "targets": 1,
    "repositories": 1,
    "findings": 3,
    "vulnerabilities": [
      {
        "id": "4cc6c3ebe85614e5e2a3aede235558fca44e5240c1a50277f819b6b74df77089",
        "report_id": "696b0651-368a-4195-bfb8-f9e0864bc698",
        "repository_name": "nguyenptk/hello-world",
        "repository_url": "https://api.github.com/repos/nguyenptk/hello-world",
        "findings": [
          {
            "id": "e74c0bbe07dfa40cdd99ecfef2531ce9bbaad6125b9b59dc4b5483ad62deab6c",
            "vulnerability_id": "4cc6c3ebe85614e5e2a3aede235558fca44e5240c1a50277f819b6b74df77089",
            "file_path": "test/test.log",
            "action": "extension",
            "description": "Log file",
            "comment": "Log files can contain secret HTTP endpoints, session IDs, API keys and other goodies",
            "file_url": "https://api.github.com/repos/nguyenptk/hello-world/blob/master/test/test.log",
            "line": 0
          },
          {
            "id": "f52c49c27cd4dcf6fe5bc674a840580933e2c002c2a7a48635d16037c063c53c",
            "vulnerability_id": "4cc6c3ebe85614e5e2a3aede235558fca44e5240c1a50277f819b6b74df77089",
            "file_path": "id_rsa.pub",
            "action": "filename",
            "description": "Public key file",
            "comment": "Shell configuration files can contain passwords, API keys, hostnames and other goodies",
            "file_url": "https://api.github.com/repos/nguyenptk/hello-world/blob/master/id_rsa.pub",
            "line": 0
          },
          {
            "id": "b944ec73197694bb5d4bc7e623000e00ba6929257ff2e835002e3738fe4348df",
            "vulnerability_id": "4cc6c3ebe85614e5e2a3aede235558fca44e5240c1a50277f819b6b74df77089",
            "file_path": "test.log",
            "action": "extension",
            "description": "Log file",
            "comment": "Log files can contain secret HTTP endpoints, session IDs, API keys and other goodies",
            "file_url": "https://api.github.com/repos/nguyenptk/hello-world/blob/master/test.log",
            "line": 0
          }
        ]
      }
    ]
  }
}
```
### 2. Reject request with a few reason
Currently, I always let the Scanner returns status_code=200 and the error message is sent in the body. For examples:
```
{
  "message": [
    {
      "Code": 401,
      "Msg": "Error cloning repository nguyenptk/hello-world: authentication required\n"
    }
  ]
}
```
```
{
  "message": [
    {
      "Code": 403,
      "Msg": "Failed to gather target paths for repo: nguyenptk/hello-world"
    }
  ]
}
```

### How about the license
I cloned the core scanning from the [grab/secret-scanner](https://github.com/grab/secret-scanner) then I modified the core logic a bit and added a new HTTP wrapper.