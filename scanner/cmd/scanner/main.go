package main

import (
	"fmt"
	"net/http"

	"github.com/nguyenptk/vulnerability-scanner/scanner/common/log"
	server "github.com/nguyenptk/vulnerability-scanner/scanner/server/handlers"
	"github.com/nguyenptk/vulnerability-scanner/scanner/storages/mysql"
)

func main() {

	// Initialize DB & logger
	scanner := &server.Scanner{
		MySQL:  mysql.NewDatabase(),
		Logger: &log.Logger{},
	}
	// Create tables by gorm
	// scanner.MySQL.DB.AutoMigrate(&storages.Report{})
	// scanner.MySQL.DB.AutoMigrate(&storages.Vulnerability{})
	// scanner.MySQL.DB.AutoMigrate(&storages.Finding{})

	// Handle panic
	defer func() {
		if e := recover(); e != nil {
			err := fmt.Errorf("%v", e)
			scanner.Logger.Debug("panic convert error %s", err)
		}
	}()

	http.HandleFunc("/scan", scanner.ScanHanlder)

	http.ListenAndServe(":8090", nil)
}
